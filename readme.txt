ニュース検索.alfredworkflowのメモ

機能：
　googleニュース検索のRSSを表示させる

インストール：
　1.alfredworkflowをダウンロード
　2.ファイルをダブルクリックしてワークフローに登録

使い方：
　alfredから"ニュース"＋検索ワードを入力するとRSSの候補出力されるので、続けて選択
　

開発メモ：

基本Lesson7からの使い回しです
googleニュースのRSSにあわせて微調整をしている程度です


1.％エンコードしてURLを生成する
　早速、Googleニュース検索のRSSを試してみたら日本語の検索がうまくないようでした。
　試しにUTF-8で％エンコードしたら問題なく取得できました
　価格.comキーワード検索で実装したnkfを利用しました
　あとはURLの文字列に結合するだけです


2.RSSを取得する
　Lesson7と同様にcURLでRSSを取得します
　今回は、一旦RSSを変数で受けるようにしてみました
　特に問題なく、後続のタグ抽出ができました
　Lesson7はなにが悪かったのかな、まあいいか


3.RSSからタグの内容を取得する
　こちらもLesson7と同様にsedとgrepでタグの中身をとりだしています
　違っている点は、取り出し元が変数になっていることです
　ただ、実装したらdescriptionがうまくとりだせません
　結局、タイトルが、『記事のタイトル ー ニュース発信元』という構成だったので
　前後で分割してAlfredのタイトルとサブタイトルにセットしました
　下記の部分で取り出したtitleタグの中身を『-』で分割しています

　arry=(${title[i]//-/ })


4.JSON出力フォーマットのXMLを作成する
　上記の分離を受けてtitleに記事のタイトルをsubtitleにニュース発信元をセットしています
  あと、記事のタイトルが長いと『…』で途中が切れるので24文字としました
  （文字のフォントによって微妙に異なりますが）

　${arry[0]::24}
 
 
5.日付を追加する
　RSSを眺めていたらpubdateタグがあり、発信日時が格納されているようです
　そこでサブタイトルの発信元の後に追加してみました
　グリニッチ標準時で曜日まで編集済み項目だったのですが、年月日だけ部分参照でとりだしました 
　タグの名前がpubDateだったのでマッチしなくてちょっと悩みました
　こんな感じのタグです
 
　<pubDate>Sun, 28 Feb 2021 23:30:00 GMT</pubDate>


背景：
 Lesson7のRSSツールを改造してRSSを検索できるようにしました
 googleニュースが検索用のRSSを発見して作ってみました
 それにしても、適当なワードでも、色々な記事があるものですね
 わりと楽しめます


ver1.1(2021-03-28)：
・ScriptFilterのJSONフォーマットの編集をワンライナーから1行1プロパティーに変更

　修正前
　json=$json'{"title":"'${arry[0]::24}'","subtitle":"'${arry[1]}' - '${pdate[i]:9:4}.${pdate[i]:6:3}.${pdate[i]:4:2}'","arg":"'${link[i]}'"}'
 
 　修正後
  json=$json'{"title":"'${arry[0]::24}'",'
  json=$json'"subtitle":"'${arry[1]}' - '${pdate[i]:9:4}.${pdate[i]:6:3}.${pdate[i]:4:2}'",'
  json=$json'"arg":"'${link[i]}'"}'

・ソースとは関係ありませんが、サンプル動画を投稿


ver1.2(2021-04-04)：
   シェルスクリプトをbashからzshに変更

ver1.3(2021-05-16)：
   zshで変数内置換後の配列格納の際に空白で分割されない不具合に対応
  
   変更前
   arry=(${title[i]//-/ })
 　変更後
   arry=(`echo ${title[i]/-/ }`) 
   
   『//』を『/』に変更した部分は、初めの『-』だけで分割するようにしたものです
   ニュース発信元の文字列に『-』があるものがあったので、合わせて修正しました
    
 　ちなみにzshのスクリプトに以下のように、オプションを指定をする方法もあるそうです
   setopt SH_WORD_SPLIT
   


